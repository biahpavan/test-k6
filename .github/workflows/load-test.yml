name: K6 Load Testing

on:
  push:
    branches: [main]

jobs:
  k6_test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Install k6
      run: |
        sudo apt-get update
        sudo apt-get -y install gnupg2
        sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get -y install k6

    - name: Run k6 test
      run: k6 run --out cloud --quiet scripts/smoke.js

    - name: Send results to K6 Cloud
      run: k6 cloud 792228 --project-id 3640740 --token ${{ secrets.K6_CLOUD_API_TOKEN }}